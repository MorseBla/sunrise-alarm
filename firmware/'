import time
from rgbmatrix import graphics
from .base import Layer
class ClockOverlay(Layer):
    def __init__(self, font_path="/home/admin/Desktop/sunrise-alarm/firmware/display/fonts/6x12.bdf"): #5x8 or 6x12
        self.font = graphics.Font()
        self.font.LoadFont(font_path)
        self.color = graphics.Color(255, 255, 255)
        #self.color = graphics.Color(0, 0, 0)
        self.last_draw = 0
        self.text_cache = ""
        self.font_width = 6
        self.font_height = 12

    def update(self, canvas, dt):
        now = time.localtime()
        current_text = time.strftime("%H:%M:%S", now)
        #print(current_text)
        current_text = current_text[:-3]
        # Redraw only if text changed to save time
        if current_text != self.text_cache:
            self.text_cache = current_text
            self.last_draw = time.time()

        # Position (bottom-right corner)
        #x = canvas.width - len(current_text)*8 - 2
        x = 1
        y = canvas.height/2  + self.font_height/2
        text_width = len(current_text) * self.font_width

        pad = 1
        rect_x0 = x - pad
        rect_y0 = y - pad
        rect_x1 = x + text_width + pad
        rect_y1 = y + self.font_height + pad
        
        rect_x0 = max(0, rect_x0)
        rect_y0 = int(max(0, rect_y0))
        rect_x1 = max(canvas.width - 1, rect_x1)
        rect_y1 = int(min(canvas.height - 1, rect_y1))
        
        print(rect_y0)
        print(rect_y1)
        for xx in range(rect_x0, rect_x1 + 1):
            for yy in range(rect_y0, rect_y1 + 1):
                canvas.SetPixel(xx, yy, 0, 0, 0)

        graphics.DrawText(canvas, self.font, x, y, self.color, current_text)

